<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <title>是男人坚持20秒</title>
    <!-- Phaser 3 - 最流行的 HTML5 游戏框架 -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #1a1a2e;
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
        }

        .game-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px;
            text-align: center;
            color: #fff;
            z-index: 100;
            background: linear-gradient(180deg, rgba(0,0,0,0.6) 0%, transparent 100%);
        }

        .header h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .tips {
            font-size: 0.85rem;
            color: #adb5bd;
        }

        #game-canvas {
            border-radius: 12px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.6);
        }

        .timer-display {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 1.8rem;
            color: #fff;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 100;
        }

        .timer-display span {
            color: #ffd700;
            font-weight: bold;
            font-size: 2.2rem;
        }

        #restart-btn {
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            z-index: 200;
            width: 280px;
            padding: 20px;
            font-size: 1.1rem;
            font-weight: bold;
            border: none;
            border-radius: 16px;
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: #fff;
            cursor: pointer;
            display: none;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.5);
            transition: all 0.2s ease;
            line-height: 1.6;
        }

        #restart-btn:hover {
            transform: translate(-50%, -50%) scale(1.05);
            box-shadow: 0 15px 40px rgba(231, 76, 60, 0.6);
        }

        #restart-btn:active {
            transform: translate(-50%, -50%) scale(0.98);
        }

        .result-time {
            font-size: 2.5rem;
            color: #ffd700;
            display: block;
            margin: 10px 0;
        }

        .result-msg {
            font-size: 0.9rem;
            color: rgba(255,255,255,0.8);
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>🎮 是男人坚持20秒</h1>
            <p class="tips">📱 手机倾斜 / ⌨️ 方向键控制</p>
        </div>

        <div id="game-canvas"></div>

        <div class="timer-display">
            ⏱️ <span id="time-display">0</span> 秒
        </div>
    </div>

    <button type="button" id="restart-btn">
        💪 再来一次！
        <span class="result-time" id="result-time"></span>
        <span class="result-msg" id="result-msg"></span>
    </button>

    <script>
    /**
     * 是男人坚持20秒 - Phaser 3 重制版
     */
    (function() {
        'use strict';

        // ==================== 游戏配置 ====================
        const CONFIG = {
            width: 320,
            height: 320,
            playerSize: 22,
            playerSpeed: 200,
            ballSize: 12,
            ballSpeed: 150,
            ballSpawnInterval: 800,
            ballColors: [0xFF0000, 0xFF7F00, 0xFFFF00, 0x00FF00, 0x007FFF, 0x00FFFF, 0xFF00FF, 0xFFFFFF]
        };

        // ==================== 游戏状态 ====================
        let gameTime = 0;
        let isGameOver = false;
        let ballSpawnTimer = null;
        let gameTimeTimer = null;

        // ==================== DOM 元素 ====================
        const timeDisplay = document.getElementById('time-display');
        const restartBtn = document.getElementById('restart-btn');
        const resultTime = document.getElementById('result-time');
        const resultMsg = document.getElementById('result-msg');

        // ==================== 主游戏场景 ====================
        class GameScene extends Phaser.Scene {
            constructor() {
                super({ key: 'GameScene' });
                this.player = null;
                this.balls = null;
                this.cursors = null;
                this.wasd = null;
            }

            create() {
                // 设置背景
                this.cameras.main.setBackgroundColor('#24292F');

                // 创建玩家
                this.player = this.add.rectangle(
                    CONFIG.width / 2,
                    CONFIG.height / 2,
                    CONFIG.playerSize,
                    CONFIG.playerSize,
                    0xFFFFFF
                );
                this.physics.add.existing(this.player);
                this.player.body.setCollideWorldBounds(true);

                // 添加玩家文字
                this.playerText = this.add.text(
                    CONFIG.width / 2,
                    CONFIG.height / 2,
                    '龍',
                    { fontSize: '14px', fontFamily: 'sans-serif', color: '#000' }
                ).setOrigin(0.5);

                // 创建小球组
                this.balls = this.physics.add.group();

                // 设置碰撞检测
                this.physics.add.overlap(this.player, this.balls, this.hitBall, null, this);

                // 键盘控制
                this.cursors = this.input.keyboard.createCursorKeys();
                this.wasd = this.input.keyboard.addKeys({
                    up: Phaser.Input.Keyboard.KeyCodes.W,
                    down: Phaser.Input.Keyboard.KeyCodes.S,
                    left: Phaser.Input.Keyboard.KeyCodes.A,
                    right: Phaser.Input.Keyboard.KeyCodes.D
                });

                // 陀螺仪控制
                this.setupGyroscope();

                // 开始游戏
                this.startGame();
            }

            update() {
                if (isGameOver) return;

                const body = this.player.body;
                const speed = CONFIG.playerSpeed;

                // 重置速度
                body.setVelocity(0);

                // 键盘控制
                if (this.cursors.left.isDown || this.wasd.left.isDown) {
                    body.setVelocityX(-speed);
                } else if (this.cursors.right.isDown || this.wasd.right.isDown) {
                    body.setVelocityX(speed);
                }

                if (this.cursors.up.isDown || this.wasd.up.isDown) {
                    body.setVelocityY(-speed);
                } else if (this.cursors.down.isDown || this.wasd.down.isDown) {
                    body.setVelocityY(speed);
                }

                // 同步玩家文字位置
                this.playerText.setPosition(this.player.x, this.player.y);
            }

            setupGyroscope() {
                const self = this;

                const handleOrientation = (event) => {
                    if (isGameOver || !self.player) return;

                    let beta = event.beta;   // 前后 [-180, 180]
                    let gamma = event.gamma; // 左右 [-90, 90]

                    if (beta === null || gamma === null) return;

                    // 限制范围
                    const maxTilt = 30;
                    beta = Phaser.Math.Clamp(beta, -maxTilt, maxTilt);
                    gamma = Phaser.Math.Clamp(gamma, -maxTilt, maxTilt);

                    // 转换为速度
                    const vx = (gamma / maxTilt) * CONFIG.playerSpeed;
                    const vy = (beta / maxTilt) * CONFIG.playerSpeed;

                    self.player.body.setVelocity(vx, vy);
                };

                // iOS 13+ 需要请求权限
                if (typeof DeviceOrientationEvent !== 'undefined' &&
                    typeof DeviceOrientationEvent.requestPermission === 'function') {
                    document.body.addEventListener('click', () => {
                        DeviceOrientationEvent.requestPermission()
                            .then(response => {
                                if (response === 'granted') {
                                    window.addEventListener('deviceorientation', handleOrientation);
                                }
                            })
                            .catch(console.error);
                    }, { once: true });
                } else {
                    window.addEventListener('deviceorientation', handleOrientation);
                }
            }

            startGame() {
                isGameOver = false;
                gameTime = 0;
                timeDisplay.textContent = '0';

                // 定时生成小球
                ballSpawnTimer = this.time.addEvent({
                    delay: CONFIG.ballSpawnInterval,
                    callback: this.spawnBall,
                    callbackScope: this,
                    loop: true
                });

                // 计时器
                gameTimeTimer = setInterval(() => {
                    if (!isGameOver) {
                        gameTime++;
                        timeDisplay.textContent = gameTime;
                    }
                }, 1000);
            }

            spawnBall() {
                if (isGameOver) return;

                // 随机边缘位置
                const edge = Phaser.Math.Between(0, 3);
                let x, y;

                switch (edge) {
                    case 0: x = 0; y = Phaser.Math.Between(0, CONFIG.height); break;
                    case 1: x = CONFIG.width; y = Phaser.Math.Between(0, CONFIG.height); break;
                    case 2: x = Phaser.Math.Between(0, CONFIG.width); y = 0; break;
                    case 3: x = Phaser.Math.Between(0, CONFIG.width); y = CONFIG.height; break;
                }

                // 随机颜色
                const color = Phaser.Math.RND.pick(CONFIG.ballColors);

                // 创建小球
                const ball = this.add.circle(x, y, CONFIG.ballSize / 2, color);
                this.physics.add.existing(ball);
                this.balls.add(ball);

                // 朝向玩家发射
                const angle = Phaser.Math.Angle.Between(x, y, this.player.x, this.player.y);
                const speed = CONFIG.ballSpeed + Phaser.Math.Between(0, 50);

                ball.body.setVelocity(
                    Math.cos(angle) * speed,
                    Math.sin(angle) * speed
                );
                ball.body.setBounce(1);
                ball.body.setCollideWorldBounds(true);

                // 添加发光效果
                ball.setAlpha(0.9);
                this.tweens.add({
                    targets: ball,
                    alpha: 0.6,
                    duration: 300,
                    yoyo: true,
                    repeat: -1
                });
            }

            hitBall() {
                if (isGameOver) return;
                this.gameOver();
            }

            gameOver() {
                isGameOver = true;

                // 停止定时器
                if (ballSpawnTimer) ballSpawnTimer.remove();
                clearInterval(gameTimeTimer);

                // 暂停物理
                this.physics.pause();

                // 玩家闪烁
                this.tweens.add({
                    targets: [this.player, this.playerText],
                    alpha: 0,
                    duration: 100,
                    yoyo: true,
                    repeat: 5
                });

                // 显示结果
                setTimeout(() => {
                    resultTime.textContent = `${gameTime} 秒`;
                    resultMsg.textContent = getResultMessage(gameTime);
                    restartBtn.style.display = 'block';
                }, 600);
            }
        }

        // ==================== 结果评语 ====================
        function getResultMessage(time) {
            if (time >= 20) return '🏆 真男人！太强了！';
            if (time >= 15) return '💪 不错，还差一点！';
            if (time >= 10) return '😅 一般般，继续努力！';
            if (time >= 5) return '😂 就这？再练练！';
            return '💔 太快了吧...';
        }

        // ==================== Phaser 配置 ====================
        const phaserConfig = {
            type: Phaser.AUTO,
            width: CONFIG.width,
            height: CONFIG.height,
            parent: 'game-canvas',
            backgroundColor: '#24292F',
            physics: {
                default: 'arcade',
                arcade: {
                    debug: false
                }
            },
            scene: GameScene,
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH
            }
        };

        // ==================== 启动游戏 ====================
        let game = null;

        function startNewGame() {
            if (game) {
                game.destroy(true);
            }
            restartBtn.style.display = 'none';
            game = new Phaser.Game(phaserConfig);
        }

        // 重新开始按钮
        restartBtn.addEventListener('click', startNewGame);

        // 页面加载完成后启动
        window.addEventListener('load', startNewGame);

    })();
    </script>
</body>
</html>
